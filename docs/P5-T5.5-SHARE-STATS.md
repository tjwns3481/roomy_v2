# P5-T5.5 공유 통계 기능 구현 완료

## 구현 내용

### 1. DB 마이그레이션 (share_events 테이블)

**파일**: `supabase/migrations/017_create_share_events.sql`

```sql
-- share_events 테이블
CREATE TABLE IF NOT EXISTS public.share_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  guidebook_id UUID NOT NULL REFERENCES public.guidebooks(id) ON DELETE CASCADE,
  event_type VARCHAR(50) NOT NULL,
  event_data JSONB DEFAULT '{}',
  visitor_id TEXT,
  ip_hash TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**RPC 함수**:
- `track_share_event()` - 이벤트 기록
- `get_share_stats_summary()` - 통계 요약 조회
- `get_share_daily_stats()` - 일별 통계 조회

**RLS 정책**:
- INSERT: 누구나 가능 (공개 API)
- SELECT/DELETE: 가이드북 소유자만

---

### 2. API 엔드포인트

#### POST /api/share/track

**요청**:
```typescript
{
  guidebookId: string;
  eventType: 'link_copy' | 'qr_download' | 'social_share' | 'short_url_click';
  eventData?: { platform?: 'kakao' | 'twitter' | 'facebook' };
}
```

**응답**:
```typescript
{
  success: true;
  data: { eventId: string };
}
```

#### GET /api/share/stats

**쿼리 파라미터**:
- `guidebookId` (필수): 가이드북 ID
- `period` (선택): '7d' | '30d' | 'all' (기본: 'all')

**응답**:
```typescript
{
  success: true;
  data: {
    guidebookId: string;
    period: '7d' | '30d' | 'all';
    summary: {
      totalShares: number;
      shortUrlClicks: number;
      linkCopies: number;
      qrDownloads: number;
      socialShares: { kakao, twitter, facebook };
    };
    dailyStats: [{ date, count, linkCopies, qrDownloads, socialShares }];
  };
}
```

---

### 3. 프론트엔드 훅

#### useTrackShare(guidebookId)

```typescript
const {
  trackEvent,
  trackLinkCopy,
  trackQrDownload,
  trackSocialShare,
  trackShortUrlClick,
  isTracking,
  error,
} = useTrackShare('guidebook-id');

// 사용 예시
await trackLinkCopy();
await trackSocialShare('kakao');
```

#### useShareStats(guidebookId, period)

```typescript
const {
  summary,
  dailyStats,
  isLoading,
  error,
  refresh,
  period,
} = useShareStats('guidebook-id', '30d');
```

---

### 4. 공유 모달 이벤트 추적 연동

**수정된 파일**:
- `src/components/share/ShareModal.tsx` - 훅 연동
- `src/components/share/ShareLinkSection.tsx` - onCopy 콜백
- `src/components/share/ShareQRSection.tsx` - onDownload 콜백
- `src/components/share/ShareSocialSection.tsx` - onShare 콜백

**연동 방식**:
```tsx
// ShareModal.tsx
const { trackLinkCopy, trackQrDownload, trackSocialShare } = useTrackShare(guidebook.id);

<ShareLinkSection onCopy={trackLinkCopy} />
<ShareQRSection onDownload={trackQrDownload} />
<ShareSocialSection onShare={trackSocialShare} />
```

---

### 5. 타입 정의

**파일**: `src/types/share.ts`

```typescript
export type ShareEventType = 'link_copy' | 'qr_download' | 'social_share' | 'short_url_click';
export type SocialPlatform = 'kakao' | 'twitter' | 'facebook';
export type ShareStatsPeriod = '7d' | '30d' | 'all';

export interface ShareStatsSummary { ... }
export interface DailyShareStat { ... }
export interface ShareStatsResponse { ... }
```

---

## 테스트 결과

```
 tests/api/share.test.ts (21 tests) - PASS
 tests/api/share/stats.test.ts (8 tests) - PASS
 tests/api/share/track.test.ts (9 tests) - PASS
 tests/hooks/useTrackShare.test.ts (8 tests) - PASS

Total: 46 tests passed
```

---

## 산출물

| 파일 | 설명 |
|------|------|
| `supabase/migrations/017_create_share_events.sql` | DB 마이그레이션 |
| `src/types/share.ts` | 타입 정의 |
| `src/app/api/share/track/route.ts` | 이벤트 기록 API |
| `src/app/api/share/stats/route.ts` | 통계 조회 API |
| `src/hooks/useTrackShare.ts` | 이벤트 추적 훅 |
| `src/hooks/useShareStats.ts` | 통계 조회 훅 |
| `tests/api/share/track.test.ts` | API 테스트 |
| `tests/api/share/stats.test.ts` | API 테스트 |
| `tests/hooks/useTrackShare.test.ts` | 훅 테스트 |

---

## 완료 조건 체크리스트

- [x] share_events 테이블 마이그레이션
- [x] POST /api/share/track API
- [x] GET /api/share/stats API
- [x] useTrackShare 훅
- [x] useShareStats 훅
- [x] 공유 모달에 이벤트 추적 연동
- [x] 테스트 작성 및 통과
