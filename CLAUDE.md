# CLAUDE.md

> 이 파일은 Claude Code가 프로젝트 컨텍스트를 빠르게 파악하도록 돕습니다.

## 프로젝트 개요

- **이름**: Roomy
- **설명**: 한국형 디지털 게스트 가이드북 SaaS - 숙소 정보를 모바일 친화적인 가이드북으로 제공
- **기술 스택**: Next.js 15 (App Router), Supabase, TypeScript, Tailwind CSS, shadcn/ui, Zustand

## 핵심 목표

1. 호스트가 간편하게 가이드북을 만들고 관리
2. 게스트가 모바일에서 쉽게 접근하고 AI 챗봇으로 질문
3. QR 코드 기반 빠른 접근
4. 프리미엄/무료 플랜 제공

## 빠른 시작

```bash
# 설치
npm install

# 개발 서버
npm run dev

# 테스트
npm run test

# 린트
npm run lint

# 타입 체크
npm run type-check
```

## 프로젝트 구조

```
roomy_v2/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/             # 인증 페이지 (로그인, 회원가입)
│   │   ├── (host)/             # 호스트 페이지 (대시보드, 에디터, 설정)
│   │   ├── (guest)/            # 게스트 페이지 (가이드북 뷰어)
│   │   └── api/                # API Routes
│   ├── components/
│   │   ├── ui/                 # shadcn/ui 컴포넌트
│   │   └── ...                 # Phase별로 추가 예정
│   ├── lib/
│   │   ├── supabase/           # Supabase 클라이언트
│   │   └── utils.ts            # 유틸리티 함수
│   ├── stores/                 # Zustand 스토어
│   ├── types/                  # TypeScript 타입
│   └── hooks/                  # 커스텀 훅
├── supabase/
│   └── migrations/             # DB 마이그레이션
├── tests/                      # 테스트 파일
└── docs/
    └── planning/               # 기획 문서 (Phase 0에서 생성 예정)
```

## 기획 문서 참조

| 문서 | 경로 | 내용 |
|------|------|------|
| PRD | `docs/planning/01-prd.md` | 제품 요구사항, 페르소나, 성공 지표 |
| TRD | `docs/planning/02-trd.md` | 기술 스택, 아키텍처, API 설계 |
| User Flow | `docs/planning/03-user-flow.md` | 사용자 여정, 화면 목록 |
| DB Design | `docs/planning/04-database-design.md` | ERD, RLS 정책, 마이그레이션 |
| **Design System** | `docs/DESIGN_SYSTEM.md` | **컬러, 타이포, 컴포넌트, 간격, 그림자** |
| **TASKS** | `docs/planning/06-tasks.md` | 태스크 목록, 의존성 |
| Coding Convention | `docs/planning/07-coding-convention.md` | 코딩 규칙, AI 협업 가이드 |

## 라우트 구조

### (auth) - 인증 관련
- `/login` - 로그인
- `/signup` - 회원가입

### (host) - 호스트 전용 (로그인 필요)
- `/dashboard` - 호스트 대시보드
- `/editor/[id]` - 가이드북 에디터
- `/settings` - 설정

### (guest) - 게스트 공개 페이지
- `/g/[slug]` - 가이드북 뷰어

### 랜딩 페이지
- `/` - Roomy 소개 및 시작하기

## 컨벤션

- **커밋 메시지**: Conventional Commits (한글 가능)
  - `feat(editor): 블록 추가 기능 구현`
  - `fix(viewer): 모바일 레이아웃 수정`
- **브랜치 전략**: `phase-N-*`, `feat/*`, `fix/*`
- **파일 네이밍**: kebab-case (`guide-editor.tsx`)
- **컴포넌트**: PascalCase (`GuideEditor`)

## 핵심 규칙

1. **서버 컴포넌트 우선**: 클라이언트 컴포넌트는 꼭 필요할 때만 `'use client'`
2. **RLS 우선 보안**: 모든 데이터 접근은 Supabase RLS로 보호
3. **모바일 우선**: 모든 UI는 모바일 먼저 디자인
4. **TAG 시스템**: 모든 코드에 `@TASK P#-T#` 주석 추가

## Storage 설정 (P0-T0.5)

### guidebook-images 버킷
- **용도**: 가이드북 이미지 저장 (히어로, 갤러리 등)
- **공개**: Yes (RLS로 접근 제어)
- **파일 제한**: 10MB, 이미지만 허용

### Storage RLS 정책
- **업로드**: 인증 사용자 → 자신의 폴더(user_id/guidebook_id/)에만
- **수정/삭제**: 본인 파일만
- **조회**: 공개 이미지 누구나 (게스트 뷰어)

### Helper 함수
- `get_storage_url(bucket, path)`: URL 생성
- `can_create_guidebook(user_id)`: 플랜별 생성 제한 확인
- `can_generate_with_ai(user_id)`: 플랜별 AI 생성 제한 확인

## 환경 변수

```bash
# .env.local (필수)
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
NEXT_PUBLIC_APP_URL=

# OpenAI (AI 챗봇용, P3에서 설정)
OPENAI_API_KEY=
```

---

## Phase별 진행 상황

| Phase | 상태 | 완료일 |
|-------|------|--------|
| Phase 0 | ✅ 완료 | 2024-01-28 |
| Phase 1 | ✅ 완료 | 2024-01-28 |
| Phase 2 | ✅ 완료 | 2024-01-28 |
| Phase 3 | ✅ 완료 | 2024-01-28 |
| Phase 4 | 🚀 진행중 | - |

## P0 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P0-T0.1 | 프로젝트 초기화 | ✅ | - |
| P0-T0.2 | 기획 문서 작성 | ✅ | - |
| P0-T0.3 | Supabase 클라이언트 | ✅ | - |
| P0-T0.4 | Core DB Schema | ✅ | - |
| **P0-T0.5** | **Storage + RLS** | **✅** | **2024-01-28** |

## P2 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P2-T2.1 | 게스트 가이드북 뷰어 | ✅ | 2024-01-28 |
| P2-T2.2 | 블록 렌더러 | ✅ | 2024-01-28 |
| **P2-T2.7** | **조회 통계 API** | **✅** | **2024-01-28** |

## P3 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| **P3-T3.5** | **AI 사용량 추적 및 플랜별 제한** | **✅** | **2024-01-28** |

## P4 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P4-T4.1 | 대시보드 레이아웃 | ✅ | 2024-01-28 |
| P4-T4.2 | 가이드북 목록 | ✅ | 2024-01-28 |
| **P4-T4.3** | **가이드북 생성 플로우** | **✅** | **2024-01-28** |

## P5 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| **P5-T5.2** | **QR 코드 생성 및 다운로드** | **✅** | **2024-01-28** |
| **P5-T5.4** | **단축 URL 리다이렉트** | **✅** | **2024-01-28** |

## P6 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| **P6-T6.7** | **플랜별 가이드북/AI 생성 제한 체크 미들웨어** | **✅** | **2024-01-28** |

## P7 Task 진행 현황

| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| **P7-T7.2** | **Next.js 미들웨어 인증 보호** | **✅** | **2024-01-28** |
| **P7-T7.3** | **랜딩 페이지 (히어로, 기능, FAQ, 플랜 비교)** | **✅** | **2024-01-28** |
| **P7-T7.4** | **Next.js 메타데이터 및 SEO 최적화** | **✅** | **2024-01-28** |
| **P7-T7.6** | **로딩 상태 및 스켈레톤 UI** | **✅** | **2024-01-28** |
| **P7-T7.7** | **토스트 알림 시스템 구현** | **✅** | **2024-01-28** |

---

## Lessons Learned

> 에이전트가 난관을 극복하며 발견한 교훈을 기록합니다.

### [2024-01-28] P0-T0.5 Storage RLS 설정 (Storage, RLS, Idempotent)
- **상황**: Supabase Storage bucket 및 RLS 정책 설정, view_stats 테이블 생성
- **배운 점**:
  1. **멱등성**: 마이그레이션은 여러 번 실행해도 안전하도록 DROP IF EXISTS, ON CONFLICT 패턴 사용
  2. **Storage RLS**: bucket_id 확인 + foldername 함수로 경로 기반 권한 제어 가능
  3. **Helper 함수**: 플랜별 제한 (free: 1개, pro: 5개, business: unlimited) 함수화로 비즈니스 로직 재사용성 높임
  4. **문서화**: 마이그레이션 요약 + DATABASE_SETUP.md 업데이트로 향후 개발 용이성 확보
- **교훈**: 초기 DB 설정에서 Helper 함수를 충분히 준비하면 P1+ 단계 개발 속도 향상

- 프로젝트 초기화 시 불필요한 코드 삭제가 중요함 (P0-T0.1)

### [2024-01-28] P5-T5.4 단축 URL 리다이렉트 (RPC, Edge Runtime, Redirect)
- **상황**: 단축 URL(/s/[code])에서 가이드북 페이지(/g/[slug])로 리다이렉트
- **배운 점**:
  1. **Edge Runtime**: 빠른 리다이렉트를 위해 `export const runtime = 'edge'` 사용
  2. **RPC 함수**: 클릭 수 증가와 slug 조회를 원자적으로 처리하여 race condition 방지
  3. **혼동 문자 제외**: 단축 코드 생성 시 I, l, O, 0, 1 등 혼동되는 문자 제외
  4. **폴백 패턴**: RPC 실패 시 직접 쿼리로 대체하여 안정성 확보
- **교훈**: 301 영구 리다이렉트는 SEO에 유리하지만, 단축 URL 변경 시 주의 필요

### [2024-01-28] P2-T2.7 조회 통계 API 구현 (API, RPC, ViewTracker)
- **상황**: 게스트 페이지 조회수 추적 및 통계 API 구현
- **배운 점**:
  1. **클라이언트 추적**: ViewTracker 컴포넌트로 세션당 1회만 조회수 증가 (중복 방지)
  2. **RPC 함수**: Supabase RPC로 조회수 증가 + 로그 삽입을 원자적으로 처리
  3. **Fallback 패턴**: RPC 실패 시 직접 UPDATE로 대체 가능하도록 구현
  4. **익명화**: IP 해시로 방문자 정보 보호 (개인정보 보호)
- **교훈**: API 테스트 시 Mock 체인 구조를 정확히 맞춰야 함 (from().select().eq().single() 체인)

### [2024-01-28] P3-T3.5 AI 사용량 추적 및 플랜별 제한 (AI, RPC, Usage)
- **상황**: AI 생성 기능에 플랜별 사용량 제한 구현 (free: 3회, pro: 30회, business: 무제한)
- **배운 점**:
  1. **RPC 함수 패턴**: `check_ai_limit()` 함수로 플랜 조회 + 사용량 카운트 + 제한 계산을 원자적으로 처리
  2. **Service Role 사용**: 사용량 기록은 RLS를 우회해야 하므로 `createAdminClient()` 사용
  3. **테스트 격리**: IP 기반 rate limiting으로 인해 각 테스트에 고유한 IP를 할당해야 테스트 격리 가능
  4. **타입 일관성**: RPC 반환 형식(snake_case) → TypeScript(camelCase) 변환 필수
- **교훈**: 기존 API에 새 기능을 통합할 때 기존 테스트의 mock도 함께 업데이트해야 함

### [2024-01-28] P4-T4.3 가이드북 생성 플로우 (2-Step, Slug, Validation)
- **상황**: 가이드북 생성 2단계 플로우 구현 (기본정보 입력 → 생성 방식 선택)
- **배운 점**:
  1. **자동 슬러그 생성**: 제목 입력 시 자동으로 URL 친화적 슬러그 생성 (한글 → 영문)
  2. **실시간 유효성 검사**: Zod 스키마를 클라이언트와 서버에서 공유하여 일관된 검증
  3. **테마 시스템**: 테마별 기본 색상을 미리 정의하여 일관된 디자인 제공
  4. **2단계 플로우**: Step 상태 관리로 모달과 페이지 모두에서 동일한 UX 제공
- **교훈**: 폼 입력 시 자동화(auto-slug)와 수동 커스터마이징 옵션을 모두 제공하면 UX 개선

### [2024-01-28] P5-T5.2 QR 코드 생성 및 다운로드 (QRCode, PDF, MultiFormat)
- **상황**: QR 코드 표시, 다운로드, 인쇄용 PDF 생성 기능 구현
- **배운 점**:
  1. **라이브러리 선택**: qrcode.react (클라이언트) + qrcode (서버) 조합으로 양쪽 지원
  2. **고해상도 렌더링**: 다운로드용 캔버스는 2배 크기로 생성하여 고품질 이미지 제공
  3. **PDF 템플릿**: jsPDF로 A4 크기에 QR + 안내문을 자동 배치하는 인쇄용 템플릿 생성
  4. **숨겨진 캔버스 패턴**: 다운로드용 고해상도 캔버스를 숨김 처리하여 UI 방해 없이 다운로드 구현
- **교훈**: 다양한 형식 지원 시 각 형식별 최적의 라이브러리를 조합하여 사용하면 품질 향상

### [2024-01-28] P6-T6.7 플랜별 제한 체크 미들웨어 (Middleware, 402, PaymentRequired)
- **상황**: 가이드북/AI 생성 시 플랜별 제한 체크 미들웨어 구현
- **배운 점**:
  1. **미들웨어 패턴**: `withGuidebookLimit`, `withAIGenerationLimit`로 재사용 가능한 미들웨어 구현
  2. **402 Payment Required**: 제한 초과 시 403 대신 402로 결제 유도 의미 명확화
  3. **에러 응답 표준화**: `LIMIT_EXCEEDED` 에러 코드 + `upgradeUrl` 포함으로 클라이언트 처리 용이
  4. **경고 메시지**: 제한 근접 시 사전 경고로 사용자 경험 개선
- **교훈**: API 응답 설계 시 클라이언트의 다음 행동을 고려한 정보(upgradeUrl 등)를 포함하면 UX 개선

### [2024-01-28] P7-T7.7 토스트 알림 시스템 구축 (Toast, UX, Consistency)
- **상황**: Sonner 기반 토스트 알림 시스템 구현 및 기존 훅 통합
- **배운 점**:
  1. **중앙 집중식 메시지 관리**: 상수로 관리하여 일관성과 유지보수성 향상
  2. **Promise 기반 토스트**: 자동 상태 변화로 개발자 경험 개선
  3. **액션 버튼**: 제한 초과 시 업그레이드 버튼으로 전환율 향상 가능
  4. **기존 훅 통합**: 점진적 통합으로 기존 코드와 조화
- **교훈**: 토스트 시스템은 초기에 잘 설계하면 전체 앱의 UX 일관성을 크게 향상시킬 수 있음

### [2024-01-28] P7-T7.4 Next.js 메타데이터 및 SEO 최적화 (Metadata, OpenGraph, JSON-LD)
- **상황**: 검색 엔진 최적화를 위한 메타데이터, sitemap, robots.txt, JSON-LD 구현
- **배운 점**:
  1. **동적 메타데이터**: `generateMetadata` 함수로 페이지별 동적 메타데이터 생성 (게스트 가이드북)
  2. **JSON-LD 패턴**: 구조화된 데이터로 검색 결과 품질 향상 (WebApplication, Article, Organization)
  3. **Robots 설정**: 페이지별 noindex/nofollow로 인증/호스트 페이지는 검색 노출 차단
  4. **동적 라우트**: sitemap.ts, robots.ts로 런타임에 동적 생성 (DB 쿼리 기반)
- **교훈**: SEO 최적화는 초기부터 설정해야 검색 엔진 인덱싱에 유리함. metadataBase 설정 필수!

### [2024-01-28] P7-T7.6 로딩 상태 및 스켈레톤 UI (Loading, Skeleton, UX)
- **상황**: 모든 주요 페이지에 로딩 상태 및 스켈레톤 UI 구현
- **배운 점**:
  1. **Next.js App Router 통합**: `loading.tsx` 파일을 자동으로 Suspense 경계로 활용
  2. **스켈레톤 일관성**: 실제 콘텐츠와 유사한 레이아웃으로 구성하여 레이아웃 시프트 최소화
  3. **접근성 필수**: `role="status"`, `aria-label`로 스크린 리더 지원
  4. **컴포넌트 재사용**: LoadingSpinner, LoadingOverlay를 범용 컴포넌트로 설계
- **교훈**: 로딩 UI는 단순한 스피너보다 실제 콘텐츠 구조를 반영한 스켈레톤이 사용자 경험 개선에 효과적

### [2024-01-29] P8-S5-T1 대시보드 폴리싱 (AirBnB, StatCard, GuidebookCard)
- **상황**: AirBnB 호스트 대시보드 스타일로 대시보드 리뉴얼
- **배운 점**:
  1. **컴포넌트 분리**: StatCard와 GuidebookCard를 독립된 재사용 컴포넌트로 분리하여 유지보수성 향상
  2. **AirBnB 디자인 시스템**: `shadow-airbnb-*`, `text-h*`, Primary 컬러 (#FF385C) 일관성 있게 적용
  3. **호버 인터랙션**: 그림자 변화, 이미지 확대(scale-105), 제목 색상 변경으로 풍부한 인터랙션 제공
  4. **반응형 그리드**: 통계 카드(1→2→4열), 가이드북 카드(1→2→3열) 자연스러운 레이아웃 변화
  5. **빈 상태 디자인**: 단순한 메시지보다 아이콘 + 설명 + CTA 조합이 사용자 유도에 효과적
- **교훈**: 디자인 시스템을 먼저 정립하고 컴포넌트를 작은 단위로 나누면 일관성과 재사용성 모두 확보 가능

### [2024-01-29] P8-S11-T1 브랜딩 설정 페이지 구현 (Branding, ColorPicker, FontSelector, ImageUpload)
- **상황**: Pro+ 플랜 전용 커스텀 브랜딩 설정 페이지 구현 (로고, 색상, 폰트, 커스텀 CSS)
- **배운 점**:
  1. **컴포넌트 분리**: ColorPicker, FontSelector, ImageUpload를 독립 컴포넌트로 분리하여 재사용성 향상
  2. **플랜별 기능 제한**: Free 플랜은 전체 오버레이, Business 기능은 인라인 잠금으로 단계적 업그레이드 유도
  3. **실시간 미리보기**: 변경사항을 즉시 모바일 프레임에 반영하여 사용자 경험 크게 개선
  4. **Storage 업로드**: RLS로 보호된 Storage 경로 (`{user_id}/{guidebook_id}/branding/`) 사용
  5. **AirBnB 스타일 적용**: `shadow-airbnb-*`, `rounded-airbnb`, `text-body-*` 등 일관된 디자인 시스템 적용
- **교훈**: 브랜딩 기능은 재사용 가능한 작은 컴포넌트로 나누고 실시간 미리보기를 제공하면 사용자 만족도가 높아짐

### [2024-01-29] P8-S13-T1 Upsell 설정 페이지 구현 (Upsell, DragAndDrop, RequestManagement)
- **상황**: Business 플랜 전용 Upsell 아이템 관리 및 게스트 요청 처리 기능 구현
- **배운 점**:
  1. **EditorNav 컴포넌트**: 에디터 하위 페이지들(브랜딩, 리뷰, Upsell)에 공통 네비게이션을 제공하여 일관된 UX 확보
  2. **순서 변경 패턴**: 드래그앤드롭 라이브러리 없이 버튼(↑/↓) 방식으로 간단히 구현 가능
  3. **요청 관리 테이블**: 통계 카드 + 테이블 조합으로 정보 한눈에 파악
  4. **date-fns 통합**: 날짜 포맷팅에 date-fns 사용하여 한국어 로케일 지원
  5. **RPC 함수 재사용**: `can_create_upsell_item`, `get_upsell_request_stats` RPC 함수로 비즈니스 로직을 DB에 캡슐화
- **교훈**: 에디터 설정 페이지들은 공통 네비게이션 컴포넌트를 먼저 만들면 일관성과 개발 속도가 모두 향상됨

## P8 Task 진행 현황 (프로덕션 고도화)

> Touch Stay 벤치마킹 기반 UI/UX 리뉴얼 및 핵심 기능 추가

### Phase A: UI/UX 리뉴얼
| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P8-S1-T1 | 디자인 시스템 업데이트 (AirBnB 스타일) | ✅ | 2024-01-29 |
| P8-S2-T* | 게스트 뷰어 리디자인 | ⏳ 대기 | - |
| **P8-S5-T1** | **대시보드 폴리싱 (AirBnB 스타일)** | **✅** | **2024-01-29** |
| P8-S8-T1 | 통계 페이지 (데이터 대시보드) | ⏳ 대기 | - |
| P8-S9-T1 | 에디터 미리보기 개선 | ⏳ 대기 | - |
| **P8-S11-T1** | **브랜딩 설정** | **✅** | **2024-01-29** |
| P8-S12-T1 | 리뷰 설정 | ⏳ 대기 | - |
| **P8-S13-T1** | **Upsell 설정** | **✅** | **2024-01-29** |

### Phase B: 핵심 기능 추가
| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P8-T8.5 | AI 챗봇 (24/7 자동 응답) | ⏳ 대기 | - |
| P8-T8.6 | 데이터 대시보드 (통계 고도화) | ⏳ 대기 | - |
| P8-T8.7 | 커스텀 브랜딩 | ⏳ 대기 | - |

### Phase C: 한국 특화 기능
| Task | 내용 | 상태 | 완료일 |
|------|------|------|--------|
| P8-T8.8 | 한국 특화 블록 (분리수거, 보일러, 도어락) | ⏳ 대기 | - |
| P8-T8.9 | 카카오톡 알림톡 연동 | ⏳ 대기 | - |
| P8-T8.10 | 리뷰 요청 팝업 | ⏳ 대기 | - |
| P8-T8.11 | Upsell 위젯 | ⏳ 대기 | - |
