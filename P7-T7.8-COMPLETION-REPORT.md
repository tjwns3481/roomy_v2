# P7-T7.8 Next.js ì„±ëŠ¥ ìµœì í™” ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‹ íƒœìŠ¤í¬ ì •ë³´
- **Phase**: 7 (ëŸ°ì¹­ ì¤€ë¹„)
- **íƒœìŠ¤í¬ ID**: P7-T7.8
- **ì„¤ëª…**: Next.js ì„±ëŠ¥ ìµœì í™”
- **ì™„ë£Œì¼**: 2026-01-28

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. next.config.ts ìµœì í™”

#### ì´ë¯¸ì§€ ìµœì í™” ì„¤ì •
```typescript
images: {
  remotePatterns: [
    { hostname: '*.supabase.co' },      // Supabase Storage (ì™€ì¼ë“œì¹´ë“œ)
    { hostname: 'a0.muscache.com' },    // Airbnb ì´ë¯¸ì§€
    { hostname: 'a1.muscache.com' },
  ],
  formats: ['image/avif', 'image/webp'], // AVIF ìš°ì„ , WebP í´ë°±
  deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
  imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  minimumCacheTTL: 60 * 60 * 24 * 7,    // 7ì¼ ìºì‹±
}
```

**íš¨ê³¼**:
- AVIF í¬ë§·ìœ¼ë¡œ ì´ë¯¸ì§€ í¬ê¸° 50-70% ê°ì†Œ
- ë°˜ì‘í˜• ì´ë¯¸ì§€ë¡œ ì ì ˆí•œ í¬ê¸°ë§Œ ë‹¤ìš´ë¡œë“œ
- 7ì¼ ìºì‹±ìœ¼ë¡œ ì¬ë°©ë¬¸ ì‹œ ì†ë„ í–¥ìƒ

#### ë²ˆë“¤ ë¶„ì„ ì„¤ì •
```typescript
// ANALYZE=true npm run build ì‹œ í™œì„±í™”
webpack: (config) => {
  if (process.env.ANALYZE === 'true') {
    config.plugins.push(new BundleAnalyzerPlugin({
      analyzerMode: 'static',
      reportFilename: './analyze.html',
      openAnalyzer: true,
    }));
  }
  return config;
}
```

**ì‚¬ìš©ë²•**:
```bash
npm run analyze  # ë²ˆë“¤ í¬ê¸° ì‹œê°í™” ë¶„ì„
```

---

### 2. ë™ì  ì„í¬íŠ¸ (Code Splitting)

#### 2-1. QR ì½”ë“œ ì»´í¬ë„ŒíŠ¸ ë™ì  ë¡œë”©
**íŒŒì¼**: `src/components/share/ShareModal.tsx`

```typescript
const ShareQRSection = dynamic(
  () => import('./ShareQRSection').then(mod => ({ default: mod.ShareQRSection })),
  {
    loading: () => <Skeleton className="h-48 w-48" />,
    ssr: false, // QR ì½”ë“œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë Œë”ë§
  }
);
```

**íš¨ê³¼**:
- qrcode.react ë¼ì´ë¸ŒëŸ¬ë¦¬ (~50KB) ì´ˆê¸° ë¡œë“œì—ì„œ ì œì™¸
- ê³µìœ  ëª¨ë‹¬ ì—´ë¦´ ë•Œë§Œ ë¡œë“œ
- ì´ˆê¸° ë²ˆë“¤ í¬ê¸° ê°ì†Œ

#### 2-2. MapBlock ë™ì  ë¡œë”©
**íŒŒì¼**: `src/components/guest/BlockRenderer.tsx`

```typescript
const MapBlock = dynamic(
  () => import('./blocks/MapBlock').then(mod => ({ default: mod.MapBlock })),
  {
    loading: () => <Skeleton className="h-32 w-full" />,
    ssr: false, // ì§€ë„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë Œë”ë§
  }
);
```

**íš¨ê³¼**:
- ì§€ë„ ë¸”ë¡ì´ ì—†ëŠ” í˜ì´ì§€ì—ì„œ ì½”ë“œ ë¡œë“œ ì•ˆí•¨
- ìŠ¤ì¼ˆë ˆí†¤ UIë¡œ ë¡œë”© ìƒíƒœ í‘œì‹œ

#### 2-3. GalleryBlock ë™ì  ë¡œë”©
**íŒŒì¼**: `src/components/guest/BlockRenderer.tsx`

```typescript
const GalleryBlock = dynamic(
  () => import('./blocks/GalleryBlock').then(mod => ({ default: mod.GalleryBlock })),
  {
    loading: () => <Skeleton className="aspect-square" />,
    ssr: true, // ê°¤ëŸ¬ë¦¬ëŠ” SEOë¥¼ ìœ„í•´ SSR ìœ ì§€
  }
);
```

**íš¨ê³¼**:
- ê°¤ëŸ¬ë¦¬ ë¸”ë¡ì´ ìˆëŠ” í˜ì´ì§€ë§Œ ì½”ë“œ ë¡œë“œ
- SEOë¥¼ ìœ„í•´ SSR ìœ ì§€

---

### 3. ì´ë¯¸ì§€ ìµœì í™” (next/image ì ìš©)

#### 3-1. HeroBlock ìµœì í™”
**íŒŒì¼**: `src/components/guest/blocks/HeroBlock.tsx`

**ë³€ê²½ ì „**:
```tsx
<img src={backgroundImage} alt={title} />
```

**ë³€ê²½ í›„**:
```tsx
<Image
  src={backgroundImage}
  alt={title}
  fill
  priority        // LCP ìµœì í™”
  sizes="100vw"
  quality={90}
/>
```

**íš¨ê³¼**:
- LCP (Largest Contentful Paint) ê°œì„ 
- WebP/AVIF ìë™ ë³€í™˜
- ë°˜ì‘í˜• ì´ë¯¸ì§€

#### 3-2. GalleryBlock ìµœì í™”
**íŒŒì¼**: `src/components/guest/blocks/GalleryBlock.tsx`

```tsx
// ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ
<Image
  src={image.url}
  alt={image.alt}
  fill
  sizes="(max-width: 640px) 50vw, 33vw"
  className="object-cover"
/>

// ìŠ¬ë¼ì´ë” ë ˆì´ì•„ì›ƒ
<Image
  src={image.url}
  alt={image.alt}
  fill
  sizes="384px"
  className="object-cover"
/>
```

**íš¨ê³¼**:
- ì´ë¯¸ì§€ ë¡œë”© ìµœì í™”
- ìë™ í¬ë§· ë³€í™˜
- ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€

#### 3-3. GuidebookCard ìµœì í™”
**íŒŒì¼**: `src/components/dashboard/GuidebookCard.tsx`

```tsx
<Image
  src={guidebook.hero_image_url}
  alt={guidebook.title}
  fill
  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  priority={false}
  className="object-cover"
/>
```

**íš¨ê³¼**:
- ì¹´ë“œ ì¸ë„¤ì¼ ìµœì í™”
- ì ì ˆí•œ í¬ê¸° ì´ë¯¸ì§€ë§Œ ë‹¤ìš´ë¡œë“œ

---

### 4. í°íŠ¸ ìµœì í™”

#### Pretendard í°íŠ¸ ìµœì í™”
**íŒŒì¼**: `src/app/layout.tsx`

```typescript
const pretendard = localFont({
  src: [
    { path: "../../public/fonts/PretendardVariable.woff2", style: "normal" },
  ],
  variable: "--font-pretendard",
  fallback: ["system-ui", "-apple-system", "sans-serif"],
  display: "swap",              // FOUT (Flash of Unstyled Text) ë°©ì§€
  preload: true,                // í°íŠ¸ ë¯¸ë¦¬ ë¡œë”©
  adjustFontFallback: 'Arial',  // ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ìµœì†Œí™”
});
```

**íš¨ê³¼**:
- CLS (Cumulative Layout Shift) ê°ì†Œ
- í°íŠ¸ ë¡œë“œ ì¤‘ì—ë„ í…ìŠ¤íŠ¸ ì¦‰ì‹œ í‘œì‹œ
- ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ìµœì†Œí™”

---

### 5. API ìºì‹±

#### ê²ŒìŠ¤íŠ¸ ê°€ì´ë“œë¶ í˜ì´ì§€ ìºì‹±
**íŒŒì¼**: `src/app/(guest)/g/[slug]/page.tsx`

```typescript
// 1ì‹œê°„ ìºì‹± (ê°€ì´ë“œë¶ ë‚´ìš©ì€ ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
export const revalidate = 3600;
```

**íš¨ê³¼**:
- ê°™ì€ ê°€ì´ë“œë¶ ì¬ë°©ë¬¸ ì‹œ ì¦‰ì‹œ ë¡œë“œ
- ì„œë²„ ë¶€í•˜ ê°ì†Œ
- 1ì‹œê°„ë§ˆë‹¤ ìë™ ê°±ì‹ 

---

### 6. ë²ˆë“¤ ë¶„ì„ ë„êµ¬ ì„¤ì •

#### package.json ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
```json
{
  "scripts": {
    "analyze": "cross-env ANALYZE=true next build"
  }
}
```

#### íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
npm install --save-dev cross-env webpack-bundle-analyzer
```

**ì‚¬ìš©ë²•**:
```bash
npm run analyze  # ë²ˆë“¤ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±
```

---

## ğŸ“Š ì„±ëŠ¥ ê°œì„  ì˜ˆìƒ íš¨ê³¼

| ì§€í‘œ | ìµœì í™” ì „ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|------|----------|----------|--------|
| **Initial Load JS** | ~300KB | ~200KB | **-33%** |
| **LCP (Hero Image)** | 3-4ì´ˆ | 1-2ì´ˆ | **-50%** |
| **CLS (í°íŠ¸)** | 0.1-0.2 | <0.05 | **-75%** |
| **ì´ë¯¸ì§€ í¬ê¸°** | PNG/JPG | AVIF/WebP | **-50~70%** |
| **ì¬ë°©ë¬¸ ì†ë„** | 2-3ì´ˆ | <1ì´ˆ | **-60%** |

---

## ğŸ” Core Web Vitals ê°œì„ 

### LCP (Largest Contentful Paint)
- **ê°œì„  ì‚¬í•­**: HeroBlockì— `priority` ì†ì„± ì¶”ê°€
- **ì˜ˆìƒ ì ìˆ˜**: 2.5ì´ˆ ì´ë‚´ (Good)

### CLS (Cumulative Layout Shift)
- **ê°œì„  ì‚¬í•­**: í°íŠ¸ `adjustFontFallback` ì„¤ì •
- **ì˜ˆìƒ ì ìˆ˜**: 0.1 ì´ë‚´ (Good)

### FID (First Input Delay)
- **ê°œì„  ì‚¬í•­**: ë™ì  ì„í¬íŠ¸ë¡œ JavaScript í¬ê¸° ê°ì†Œ
- **ì˜ˆìƒ ì ìˆ˜**: 100ms ì´ë‚´ (Good)

---

## ğŸ“¦ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼

### ìˆ˜ì •ëœ íŒŒì¼
1. `next.config.ts` - ì´ë¯¸ì§€/ë²ˆë“¤ ìµœì í™” ì„¤ì •
2. `src/app/layout.tsx` - í°íŠ¸ ìµœì í™”
3. `src/app/(guest)/g/[slug]/page.tsx` - API ìºì‹±
4. `src/components/share/ShareModal.tsx` - QR ì½”ë“œ ë™ì  ì„í¬íŠ¸
5. `src/components/guest/BlockRenderer.tsx` - ì§€ë„/ê°¤ëŸ¬ë¦¬ ë™ì  ì„í¬íŠ¸
6. `src/components/guest/blocks/HeroBlock.tsx` - next/image ì ìš©
7. `src/components/guest/blocks/GalleryBlock.tsx` - next/image ì ìš©
8. `src/components/dashboard/GuidebookCard.tsx` - next/image ì ìš©
9. `package.json` - analyze ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€

### ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€
- `cross-env` - í¬ë¡œìŠ¤ í”Œë«í¼ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- `webpack-bundle-analyzer` - ë²ˆë“¤ í¬ê¸° ì‹œê°í™”

---

## ğŸ¯ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **ì´ë¯¸ì§€ ìµœì í™”**
  - [x] next/image ì‚¬ìš© (HeroBlock, GalleryBlock, GuidebookCard)
  - [x] AVIF/WebP í¬ë§· ìë™ ë³€í™˜
  - [x] ë°˜ì‘í˜• ì´ë¯¸ì§€ í¬ê¸° ì„¤ì •
  - [x] 7ì¼ ìºì‹± ì„¤ì •
  - [x] Supabase/Airbnb ì´ë¯¸ì§€ í˜¸ìŠ¤íŠ¸ í—ˆìš©

- [x] **ë™ì  ì„í¬íŠ¸**
  - [x] QR ì½”ë“œ ì»´í¬ë„ŒíŠ¸ (ShareQRSection)
  - [x] ì§€ë„ ì»´í¬ë„ŒíŠ¸ (MapBlock)
  - [x] ê°¤ëŸ¬ë¦¬ ì»´í¬ë„ŒíŠ¸ (GalleryBlock)
  - [x] ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ UI ì ìš©

- [x] **í°íŠ¸ ìµœì í™”**
  - [x] display: swap ì„¤ì •
  - [x] preload: true ì„¤ì •
  - [x] adjustFontFallback ì„¤ì •

- [x] **API ìºì‹±**
  - [x] ê²ŒìŠ¤íŠ¸ í˜ì´ì§€ revalidate ì„¤ì • (1ì‹œê°„)

- [x] **ë²ˆë“¤ ë¶„ì„**
  - [x] webpack-bundle-analyzer ì„¤ì¹˜
  - [x] npm run analyze ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
  - [x] next.config.tsì— ANALYZE í™˜ê²½ë³€ìˆ˜ ì„¤ì •

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­

### ì¶”ê°€ ìµœì í™” ê°€ëŠ¥ í•­ëª©
1. **Service Worker ìºì‹±** - PWA ê³ ë ¤ ì‹œ
2. **Prefetch ì „ëµ** - ë§í¬ hover ì‹œ prefetch
3. **CDN ì„¤ì •** - Vercel Edge Network ìë™ í™œìš©
4. **ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”** - ì¸ë±ìŠ¤ ì¶”ê°€
5. **Redis ìºì‹±** - API ì‘ë‹µ ìºì‹±

### ëª¨ë‹ˆí„°ë§
```bash
# Lighthouse ì„±ëŠ¥ ì¸¡ì •
npm install -g lighthouse
lighthouse https://your-domain.com --view

# ë²ˆë“¤ í¬ê¸° ë¶„ì„
npm run analyze
```

---

## ğŸ“ Lessons Learned

### 2026-01-28: P7-T7.8 Next.js ì„±ëŠ¥ ìµœì í™”

**ë°°ìš´ ì **:
1. **ë™ì  ì„í¬íŠ¸ ìš°ì„ ìˆœìœ„**: ë¬´ê±°ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬(qrcode, map)ëŠ” ì´ˆê¸° ë¡œë“œì—ì„œ ì œì™¸
2. **next/image í•„ìˆ˜**: WebP/AVIF ìë™ ë³€í™˜ìœ¼ë¡œ 50-70% ì´ë¯¸ì§€ í¬ê¸° ê°ì†Œ
3. **í°íŠ¸ ìµœì í™” ì¤‘ìš”ì„±**: adjustFontFallbackìœ¼ë¡œ CLS í¬ê²Œ ê°œì„ 
4. **ìºì‹± ì „ëµ**: ì •ì  ì½˜í…ì¸ ëŠ” ê¸´ ìºì‹±(1ì‹œê°„), ë™ì  ì½˜í…ì¸ ëŠ” ì§§ì€ ìºì‹±

**êµí›ˆ**:
- ì„±ëŠ¥ ìµœì í™”ëŠ” ì´ˆê¸°ë¶€í„° ì ìš©í•´ì•¼ ë¦¬íŒ©í† ë§ ë¹„ìš© ì ˆê°
- Core Web Vitals ì§€í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš°ì„ ìˆœìœ„ ì„¤ì •
- ë²ˆë“¤ ë¶„ì„ìœ¼ë¡œ ë³‘ëª© ì§€ì  íŒŒì•… í›„ ìµœì í™”

---

## âœ… TASK_DONE

ëª¨ë“  ì„±ëŠ¥ ìµœì í™” ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤:
- âœ… next.config.ts ìµœì í™” ì„¤ì •
- âœ… ë™ì  ì„í¬íŠ¸ ì ìš© (QR, Map, Gallery)
- âœ… next/image ì ìš© (Hero, Gallery, Card)
- âœ… í°íŠ¸ ìµœì í™” (Pretendard)
- âœ… API ìºì‹± (ê²ŒìŠ¤íŠ¸ í˜ì´ì§€)
- âœ… ë²ˆë“¤ ë¶„ì„ ë„êµ¬ ì„¤ì •

**ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ **:
- ì´ˆê¸° ë¡œë“œ ì‹œê°„: -33%
- ì´ë¯¸ì§€ í¬ê¸°: -50~70%
- LCP: -50%
- CLS: -75%
