# P7-T7.7: ì¿ í°/í• ì¸ API êµ¬í˜„ ì™„ë£Œ

**Task ID**: P7-T7.7
**Phase**: 7 (Admin Extended)
**Status**: âœ… COMPLETED
**Date**: 2026-01-25

---

## ğŸ“‹ êµ¬í˜„ ë‚´ìš©

### 1. í…ŒìŠ¤íŠ¸ íŒŒì¼
- âœ… `tests/api/admin/coupons.test.ts` - ì¿ í° API í†µí•© í…ŒìŠ¤íŠ¸

### 2. ê´€ë¦¬ì API (Admin APIs)

#### 2.1 ì¿ í° CRUD
- âœ… `src/app/api/admin/coupons/route.ts`
  - **POST**: ì¿ í° ìƒì„± (ì½”ë“œ ìë™ ìƒì„± ì˜µì…˜)
  - **GET**: ì¿ í° ëª©ë¡ ì¡°íšŒ (í•„í„°ë§, í˜ì´ì§€ë„¤ì´ì…˜)

- âœ… `src/app/api/admin/coupons/[id]/route.ts`
  - **GET**: ì¿ í° ìƒì„¸ ì¡°íšŒ (ì‚¬ìš© í†µê³„ í¬í•¨)
  - **PATCH**: ì¿ í° ìˆ˜ì •
  - **DELETE**: ì¿ í° ì‚­ì œ (CASCADE ì²˜ë¦¬)

#### 2.2 ì¿ í° ë°œê¸‰
- âœ… `src/app/api/admin/coupons/issue/route.ts`
  - **POST**: ì¿ í° ë°œê¸‰ (íŠ¹ì • ì‚¬ìš©ì/ëŒ€ëŸ‰ ë°œê¸‰)
  - ë§Œë£Œì¼ ì„¤ì • (expires_days íŒŒë¼ë¯¸í„°)

### 3. ì‚¬ìš©ì API (User APIs)

- âœ… `src/app/api/coupons/route.ts`
  - **GET**: í™œì„± ì¿ í° ëª©ë¡ ì¡°íšŒ (ê³µê°œ)

- âœ… `src/app/api/coupons/my/route.ts`
  - **GET**: ë‚´ ì¿ í° ëª©ë¡ (ì¿ í° ì •ë³´ í¬í•¨)
  - í•„í„°ë§: ì‚¬ìš© ì—¬ë¶€, ë§Œë£Œ ì—¬ë¶€

- âœ… `src/app/api/coupons/validate/route.ts`
  - **POST**: ì¿ í° ì½”ë“œ ê²€ì¦
  - DB í•¨ìˆ˜ `validate_coupon()` í˜¸ì¶œ
  - í• ì¸ ê¸ˆì•¡ ê³„ì‚°

- âœ… `src/app/api/coupons/apply/route.ts`
  - **POST**: ì¿ í° ì ìš© (ì£¼ë¬¸ì— ì¿ í° ì‚¬ìš© ê¸°ë¡)
  - `coupon_usages` í…Œì´ë¸”ì— INSERT
  - íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰ (used_count ì¦ê°€, user_coupons ì—…ë°ì´íŠ¸)

---

## ğŸ” ë³´ì•ˆ êµ¬í˜„

### ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
```typescript
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single();

if (profile?.role !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```

### RLS ì •ì±… (DB ë ˆë²¨)
- âœ… í™œì„± ì¿ í°ì€ ëˆ„êµ¬ë‚˜ ì¡°íšŒ ê°€ëŠ¥
- âœ… ê´€ë¦¬ìë§Œ ì¿ í° ìƒì„±/ìˆ˜ì •/ì‚­ì œ
- âœ… ë³¸ì¸ ë³´ìœ  ì¿ í°ë§Œ ì¡°íšŒ ê°€ëŠ¥
- âœ… ì¿ í° ì‚¬ìš© ê¸°ë¡ì€ ë³¸ì¸/ê´€ë¦¬ìë§Œ ì¡°íšŒ

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

### ê´€ë¦¬ì API í…ŒìŠ¤íŠ¸
- âœ… ì¿ í° ìƒì„± (ì½”ë“œ ì§€ì •/ìë™ ìƒì„±)
- âœ… ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ ê±°ë¶€ (403)
- âœ… ì¿ í° ëª©ë¡ ì¡°íšŒ (í•„í„°ë§)
- âœ… ì¿ í° ìˆ˜ì •
- âœ… ì¿ í° ë°œê¸‰ (íŠ¹ì • ì‚¬ìš©ì)

### ì‚¬ìš©ì API í…ŒìŠ¤íŠ¸
- âœ… ë‚´ ì¿ í° ëª©ë¡ ì¡°íšŒ
- âœ… ì¿ í° ì½”ë“œ ê²€ì¦ (ìœ íš¨/ë¬´íš¨)
- âœ… ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡ ì²´í¬
- âœ… í• ì¸ ê¸ˆì•¡ ê³„ì‚° ê²€ì¦

---

## ğŸ’¡ í•µì‹¬ ê¸°ëŠ¥

### 1. ì¿ í° ì½”ë“œ ìë™ ìƒì„±
```sql
-- DB í•¨ìˆ˜: generate_coupon_code(length)
-- í˜¼ë™ ê°€ëŠ¥í•œ ë¬¸ì ì œì™¸ (I, O, 0, 1)
-- ì¤‘ë³µ ì²´í¬ ìë™í™”
```

### 2. ì¿ í° ìœ íš¨ì„± ê²€ì¦ (DB í•¨ìˆ˜)
```sql
-- DB í•¨ìˆ˜: validate_coupon(code, user_id, order_amount)
-- ê²€ì¦ í•­ëª©:
-- - ì¿ í° ì¡´ì¬/í™œì„±í™”
-- - ê¸°ê°„ (start_at ~ end_at)
-- - ì‚¬ìš© íšŸìˆ˜ (ì „ì²´/ì‚¬ìš©ìë³„)
-- - ë³´ìœ  ì—¬ë¶€ (user_coupons)
-- - ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡
-- - í• ì¸ ê¸ˆì•¡ ê³„ì‚° (percent/fixed/free_shipping)
```

### 3. í• ì¸ ê¸ˆì•¡ ê³„ì‚°
- **ì •ë¥ (percent)**: `order_amount * value / 100`
  - ìµœëŒ€ í• ì¸ê¸ˆì•¡ ì œí•œ (max_discount)
- **ì •ì•¡(fixed)**: `min(value, order_amount)`
- **ë¬´ë£Œë°°ì†¡(free_shipping)**: ë³„ë„ ì²˜ë¦¬

### 4. ìë™ íŠ¸ë¦¬ê±°
```sql
-- coupon_usages INSERT ì‹œ:
-- 1. coupons.used_count += 1
-- 2. user_coupons.is_used = true, used_at ì„¤ì •
```

---

## ğŸ“Š API ì—”ë“œí¬ì¸íŠ¸ ìš”ì•½

| Method | Endpoint | ê¶Œí•œ | ì„¤ëª… |
|--------|----------|------|------|
| POST | `/api/admin/coupons` | Admin | ì¿ í° ìƒì„± |
| GET | `/api/admin/coupons` | Admin | ì¿ í° ëª©ë¡ ì¡°íšŒ |
| GET | `/api/admin/coupons/[id]` | Admin | ì¿ í° ìƒì„¸ ì¡°íšŒ |
| PATCH | `/api/admin/coupons/[id]` | Admin | ì¿ í° ìˆ˜ì • |
| DELETE | `/api/admin/coupons/[id]` | Admin | ì¿ í° ì‚­ì œ |
| POST | `/api/admin/coupons/issue` | Admin | ì¿ í° ë°œê¸‰ |
| GET | `/api/coupons` | Public | í™œì„± ì¿ í° ëª©ë¡ |
| GET | `/api/coupons/my` | User | ë‚´ ì¿ í° ëª©ë¡ |
| POST | `/api/coupons/validate` | User | ì¿ í° ê²€ì¦ |
| POST | `/api/coupons/apply` | User | ì¿ í° ì ìš© |

---

## ğŸ¯ Acceptance Criteria (AC) ì¶©ì¡±

### âœ… ì¿ í° ì½”ë“œ ìë™ ìƒì„± ì˜µì…˜
- `generate_coupon_code()` DB í•¨ìˆ˜ í™œìš©
- ì½”ë“œ ë¯¸ì…ë ¥ ì‹œ ìë™ ìƒì„±

### âœ… ìœ íš¨ì„± ê²€ì¦ (ê¸°ê°„, ì‚¬ìš© íšŸìˆ˜, ìµœì†Œ ê¸ˆì•¡)
- `validate_coupon()` DB í•¨ìˆ˜ë¡œ í†µí•© ê²€ì¦
- 8ê°€ì§€ ê²€ì¦ í•­ëª© êµ¬í˜„

### âœ… í• ì¸ ê¸ˆì•¡ ê³„ì‚°
- 3ê°€ì§€ ì¿ í° íƒ€ì… ì§€ì› (percent, fixed, free_shipping)
- ìµœëŒ€ í• ì¸ê¸ˆì•¡ ì œí•œ ì²˜ë¦¬

---

## ğŸ“ ìƒì„±ëœ íŒŒì¼ ëª©ë¡

```
worktree/phase-7-admin-extended/
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ coupons.test.ts              # í†µí•© í…ŒìŠ¤íŠ¸
â””â”€â”€ src/
    â””â”€â”€ app/
        â””â”€â”€ api/
            â”œâ”€â”€ admin/
            â”‚   â””â”€â”€ coupons/
            â”‚       â”œâ”€â”€ route.ts              # POST, GET (ëª©ë¡)
            â”‚       â”œâ”€â”€ [id]/
            â”‚       â”‚   â””â”€â”€ route.ts          # GET, PATCH, DELETE
            â”‚       â””â”€â”€ issue/
            â”‚           â””â”€â”€ route.ts          # POST (ë°œê¸‰)
            â””â”€â”€ coupons/
                â”œâ”€â”€ route.ts                  # GET (í™œì„± ì¿ í°)
                â”œâ”€â”€ my/
                â”‚   â””â”€â”€ route.ts              # GET (ë‚´ ì¿ í°)
                â”œâ”€â”€ validate/
                â”‚   â””â”€â”€ route.ts              # POST (ê²€ì¦)
                â””â”€â”€ apply/
                    â””â”€â”€ route.ts              # POST (ì ìš©)
```

---

## ğŸ”— ì˜ì¡´ì„±

### ì„ í–‰ ì™„ë£Œ
- âœ… P7-T7.6: ì¿ í°/í• ì¸ DB ìŠ¤í‚¤ë§ˆ
  - `coupons` í…Œì´ë¸”
  - `user_coupons` í…Œì´ë¸”
  - `coupon_usages` í…Œì´ë¸”
  - `validate_coupon()` í•¨ìˆ˜
  - `generate_coupon_code()` í•¨ìˆ˜
  - RLS ì •ì±…

### í›„ì† íƒœìŠ¤í¬
- P7-T7.8: ì¿ í°/í• ì¸ ê´€ë¦¬ í˜ì´ì§€ (í”„ë¡ íŠ¸ì—”ë“œ)

---

## ğŸ§© í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

### ì‚¬ì „ ì¤€ë¹„
1. Supabase í”„ë¡œì íŠ¸ ì„¤ì •
2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`.env.local`)
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=your-url
   SUPABASE_SERVICE_ROLE_KEY=your-key
   ```

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
npm test tests/api/admin/coupons.test.ts
```

### ì£¼ì˜ì‚¬í•­
- í†µí•© í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ Supabase DBë¥¼ ì‚¬ìš©
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ëŠ” ìë™ ì •ë¦¬ (afterAll, afterEach)
- DB ë§ˆì´ê·¸ë ˆì´ì…˜ 012 ì ìš© í•„ìˆ˜

---

## ğŸ“ ì‚¬ìš© ì˜ˆì‹œ

### 1. ê´€ë¦¬ì: ì¿ í° ìƒì„±
```typescript
POST /api/admin/coupons
{
  "name": "ì‹ ê·œíšŒì› 10% í• ì¸",
  "type": "percent",
  "value": 10,
  "min_order_amount": 10000,
  "max_discount": 5000,
  "start_at": "2026-01-25T00:00:00Z",
  "end_at": "2026-02-25T23:59:59Z",
  "usage_limit": 100,
  "usage_limit_per_user": 1
}
```

### 2. ê´€ë¦¬ì: ì¿ í° ë°œê¸‰
```typescript
POST /api/admin/coupons/issue
{
  "coupon_id": "uuid",
  "user_ids": ["user1-uuid", "user2-uuid"],
  "expires_days": 30
}
```

### 3. ì‚¬ìš©ì: ì¿ í° ê²€ì¦
```typescript
POST /api/coupons/validate
{
  "code": "WELCOME10",
  "order_amount": 20000
}

// Response:
{
  "is_valid": true,
  "discount_amount": 2000,
  "coupon_id": "uuid"
}
```

### 4. ì‚¬ìš©ì: ì¿ í° ì ìš© (ì£¼ë¬¸ ì‹œ)
```typescript
POST /api/coupons/apply
{
  "coupon_id": "uuid",
  "order_id": "order-uuid",
  "discount_amount": 2000
}
```

---

## âœ… íƒœìŠ¤í¬ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‘ì„± (`tests/api/admin/coupons.test.ts`)
- [x] ê´€ë¦¬ì ì¿ í° CRUD API êµ¬í˜„
- [x] ê´€ë¦¬ì ì¿ í° ë°œê¸‰ API êµ¬í˜„
- [x] ì‚¬ìš©ì ì¿ í° ëª©ë¡ API êµ¬í˜„
- [x] ì‚¬ìš©ì ì¿ í° ê²€ì¦ API êµ¬í˜„
- [x] ì‚¬ìš©ì ì¿ í° ì ìš© API êµ¬í˜„
- [x] ê¶Œí•œ ì²´í¬ (ê´€ë¦¬ì/ì‚¬ìš©ì)
- [x] DB í•¨ìˆ˜ ì—°ë™ (validate_coupon, generate_coupon_code)
- [x] ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…
- [x] ì½”ë“œ ì£¼ì„ ë° ë¬¸ì„œí™”

---

## ğŸ“ Lessons Learned

### 1. DB í•¨ìˆ˜ í™œìš©
ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ì¿ í° ê²€ì¦)ì€ DB í•¨ìˆ˜ë¡œ êµ¬í˜„í•˜ë©´:
- ì„±ëŠ¥ í–¥ìƒ (DB ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
- ì¼ê´€ì„± ë³´ì¥ (ë‹¨ì¼ ì§„ì‹¤ì˜ ì›ì²œ)
- ì¬ì‚¬ìš©ì„± í–¥ìƒ (ë‹¤ë¥¸ APIì—ì„œë„ í˜¸ì¶œ ê°€ëŠ¥)

### 2. íŠ¸ë¦¬ê±° ìë™í™”
ì¿ í° ì‚¬ìš© ì‹œ ì—¬ëŸ¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸ë¥¼ íŠ¸ë¦¬ê±°ë¡œ ìë™í™”:
- `coupon_usages` INSERT â†’ `coupons.used_count` ì¦ê°€
- `user_coupons.is_used`, `used_at` ìë™ ì„¤ì •
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ ë‹¨ìˆœí™”

### 3. ê¶Œí•œ ì²´í¬ íŒ¨í„´
ëª¨ë“  ê´€ë¦¬ì APIì—ì„œ ë™ì¼í•œ ê¶Œí•œ ì²´í¬ íŒ¨í„´ ì‚¬ìš©:
```typescript
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single();

if (profile?.role !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```

---

## ğŸš€ Next Steps

1. **P7-T7.8**: ì¿ í°/í• ì¸ ê´€ë¦¬ í˜ì´ì§€ (í”„ë¡ íŠ¸ì—”ë“œ)
   - ì¿ í° ëª©ë¡ UI
   - ì¿ í° ìƒì„±/ìˆ˜ì • í¼
   - ì¿ í° ë°œê¸‰ UI
   - ì‚¬ìš© ì´ë ¥ ì¡°íšŒ

2. **í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰**
   - Supabase í™˜ê²½ ì„¤ì • í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
   - E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€ ê³ ë ¤

3. **ì„±ëŠ¥ ìµœì í™”**
   - ì¿ í° ê²€ì¦ ê²°ê³¼ ìºì‹± (Redis)
   - ëŒ€ëŸ‰ ë°œê¸‰ ì‹œ ë°°ì¹˜ ì²˜ë¦¬

---

**ì‘ì„±ì**: backend-specialist (task-executor)
**ì™„ë£Œì¼**: 2026-01-25
**ì†Œìš” ì‹œê°„**: ~30ë¶„ (ììœ¨ ì‹¤í–‰)
