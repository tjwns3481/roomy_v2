# P7-T7.11: 재고 관리 페이지 구현 완료

## 개요

관리자가 상품 재고를 조회하고 관리할 수 있는 웹 인터페이스를 구현했습니다.

## 구현된 기능

### 1. 재고 관리 페이지 (`src/app/admin/inventory/page.tsx`)

**주요 기능:**
- 상품별 재고 현황 표시
- 저재고 경고 표시 (재고 ≤ 경고 기준)
- 품절 상품 강조 표시
- 재고 통계 대시보드:
  - 전체 상품 수
  - 저재고 상품 수
  - 품절 상품 수
  - 총 재고 가치

**필터 기능:**
- 상품명/슬러그 검색
- 저재고 상품만 보기
- 페이지네이션

**데이터 소스:**
- Supabase RLS 정책으로 보호된 products 테이블
- `get_low_stock_products()` RPC 함수 활용

### 2. 재고 목록 컴포넌트 (`src/components/admin/inventory-list.tsx`)

**주요 기능:**
- 재고 통계 카드 (4개)
- 검색 및 필터링 UI
- 재고 현황 테이블:
  - 상품명 (상품 편집 페이지 링크)
  - 현재 재고
  - 경고 기준
  - 상태 배지 (품절/부족/정상)
  - 단가
  - 재고 가치 (재고 × 단가)
  - 조정 버튼

**인터랙션:**
- 재고 조정 모달 열기
- 페이지네이션
- URL 기반 필터 상태 관리

### 3. 재고 조정 컴포넌트 (`src/components/admin/inventory-adjustment.tsx`)

**주요 기능:**
- 현재 재고 표시
- 빠른 조정 버튼 (-10, -5, -1, +1, +5, +10)
- 재고 수량 직접 입력
- 조정 사유 입력 (필수)
- 변경 전/후 미리보기

**탭 구조:**
- **재고 조정** 탭: 재고 수량 변경
- **변경 이력** 탭: 재고 변경 이력 조회

**API 연동:**
- POST /api/admin/inventory/adjust

### 4. 재고 이력 컴포넌트 (`src/components/admin/inventory-history.tsx`)

**주요 기능:**
- 재고 변경 이력 테이블
- 변경 타입 필터 (전체/입고/출고/조정)
- 변경 타입별 배지 표시
- 변경량 색상 표시 (증가: 녹색, 감소: 빨강)
- 처리자 정보 표시

**표시 정보:**
- 일시
- 타입 (입고/출고/조정)
- 변경량
- 변경 전 재고
- 변경 후 재고
- 사유
- 처리자 (시스템/사용자 이메일)

**API 연동:**
- GET /api/admin/inventory/history?product_id={id}&type={type}

### 5. 재고 이력 API (`src/app/api/admin/inventory/history/route.ts`)

**엔드포인트:**
- GET /api/admin/inventory/history

**쿼리 파라미터:**
- product_id: 상품 ID 필터
- type: 변경 타입 (in/out/adjust)
- reference_type: 참조 타입 (order/manual/return/damage)
- start_date: 시작 날짜
- end_date: 종료 날짜
- page: 페이지 번호 (기본: 1)
- limit: 페이지당 항목 수 (기본: 50)

**응답 형식:**
```json
{
  "data": [
    {
      "id": "uuid",
      "product_id": "uuid",
      "type": "adjust",
      "quantity": 10,
      "reason": "재고 실사",
      "stock_before": 50,
      "stock_after": 60,
      "created_at": "2026-01-25T...",
      "product": {
        "id": "uuid",
        "name": "상품명",
        "slug": "product-slug",
        "stock": 60
      },
      "creator": {
        "id": "uuid",
        "email": "admin@example.com"
      }
    }
  ],
  "meta": {
    "total": 100,
    "page": 1,
    "limit": 50
  }
}
```

### 6. TypeScript 타입 정의 (`src/types/inventory.ts`)

**주요 타입:**
- `InventoryLog`: 재고 변경 로그
- `InventoryWithProduct`: 상품 정보가 포함된 로그
- `LowStockProduct`: 저재고 상품 정보
- `ProductInventorySummary`: 상품 재고 요약
- `AdjustStockRequest`: 재고 조정 요청
- `SetStockRequest`: 재고 설정 요청

**Zod 스키마:**
- `adjustStockSchema`: 재고 조정 검증
- `setStockSchema`: 재고 설정 검증
- `inventoryQuerySchema`: 이력 조회 쿼리 검증

### 7. 데이터베이스 타입 업데이트 (`src/types/database.types.ts`)

**추가된 필드:**
- `products.stock`: 현재 재고 수량
- `products.stock_alert_threshold`: 저재고 경고 기준

**추가된 테이블:**
- `inventory_logs`: 재고 변경 이력

**추가된 RPC 함수:**
- `check_stock_availability`: 재고 가용성 확인
- `deduct_stock`: 재고 차감
- `add_stock`: 재고 추가
- `adjust_stock`: 재고 조정
- `get_low_stock_products`: 저재고 상품 조회
- `get_product_inventory_summary`: 상품 재고 요약

## 디자인 시스템 준수

### 색상
- Primary: Vibe Blue (#3B82F6) - 입고 배지
- Destructive: Red - 품절, 출고 배지
- Amber: #F59E0B - 저재고 경고
- Secondary: Gray - 조정 배지

### 폰트
- 본문: 기본 폰트
- 재고 수량: font-mono (가독성)

### 컴포넌트
- shadcn/ui 기반:
  - Card, Table, Badge, Button
  - Dialog, Tabs, Form
  - Input, Textarea, Select

## 보안

- 모든 API는 관리자 권한 확인 (`isAdminUser`)
- RLS 정책으로 데이터베이스 레벨 보호
- 서버 컴포넌트 우선 사용
- 클라이언트 컴포넌트는 'use client' 명시

## 테스트 가능 시나리오

1. **재고 조회**
   - /admin/inventory 접속
   - 전체 상품 재고 현황 확인
   - 저재고 필터 적용

2. **재고 조정**
   - 상품 옆 "조정" 버튼 클릭
   - 빠른 조정 버튼으로 수량 변경
   - 사유 입력 후 저장
   - 변경 이력 탭에서 확인

3. **재고 이력 조회**
   - 재고 조정 모달에서 "변경 이력" 탭 선택
   - 타입 필터 적용 (입고/출고/조정)
   - 변경 내역 확인

4. **저재고 경고**
   - 재고가 경고 기준 이하인 상품 자동 표시
   - "저재고만 보기" 필터로 빠른 확인

## 파일 구조

```
src/
├── app/
│   ├── admin/
│   │   └── inventory/
│   │       └── page.tsx                    # 재고 관리 메인 페이지
│   └── api/
│       └── admin/
│           └── inventory/
│               ├── route.ts                # 재고 목록 API
│               ├── adjust/
│               │   └── route.ts            # 재고 조정 API
│               ├── history/
│               │   └── route.ts            # 재고 이력 API (새로 추가)
│               ├── alerts/
│               │   └── route.ts            # 저재고 알림 API
│               └── logs/
│                   └── route.ts            # 재고 로그 API
├── components/
│   └── admin/
│       ├── inventory-list.tsx              # 재고 목록 컴포넌트
│       ├── inventory-adjustment.tsx        # 재고 조정 모달
│       └── inventory-history.tsx           # 재고 이력 컴포넌트 (새로 추가)
└── types/
    ├── inventory.ts                        # 재고 타입 정의
    └── database.types.ts                   # DB 타입 (stock 필드 추가)
```

## 의존성

### 기존 의존성 활용
- Next.js 15 (App Router)
- React Hook Form + Zod
- shadcn/ui 컴포넌트
- Framer Motion (애니메이션)
- Supabase Client

### 새로운 의존성 없음

## 완료 상태

✅ 재고 목록 페이지 구현
✅ 재고 조정 컴포넌트 구현
✅ 재고 이력 조회 컴포넌트 구현
✅ 재고 이력 API 구현
✅ TypeScript 타입 정의
✅ 데이터베이스 타입 업데이트
✅ 타입 체크 통과 (inventory 모듈)
✅ 저재고 경고 표시
✅ 디지털 상품 지원 (무한 재고 옵션은 DB 레벨에서 처리)

## 알려진 이슈

없음 (inventory 모듈은 모든 타입 체크 통과)

---

**구현 완료일:** 2026-01-25
**태스크:** P7-T7.11
**구현자:** Claude Sonnet 4.5
